<html>
  <head>
  <meta charset="utf-8">
  <meta lang="en">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Doug Skinner</title>
  <link rel="shortcut icon" href="/img/favicon.ico" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link href="/static/css/custom.css" rel="stylesheet">
  <link href="/assets/main.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script src="/static/js/custom.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-97386400-1', 'auto');
      ga('send', 'pageview');
  </script>
</head>

  <body>
    <div class="hero">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-12 col-md-10 col-lg-8 col-xl-6 mx-auto">
        <h1 class="display-4 text-center">Doug Skinner</h1>
        <h1 class="display-5 text-center">Programmer, Photographer, Writer</h1>
      </div>
    </div>
  </div>
</div>

    <nav class="navbar fixed-top navbar-expand-md navbar-light bg-light">
  <a class="navbar-brand" href="/">DS</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav ml-auto text-center">
      <li class="nav-item">
        <a class="nav-link" href="/">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/about.html">About</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/photos.html">Photos</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/projects.html">Projects</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/writings.html">Writings</a>
      </li>
    </ul>
  </div>
</nav>

    <div class="container">
      <div class="row mobile_padding content">
        <div class="col-12 mobile_padding">
          <div class="card shadow">
            <img class="card-img-top" style="max-height:15em;" src="/img/post_images/shell.jpg" alt="placeholder" data-toggle="tooltip" data-placement="top" title="Photo by Clever Visuals on Unsplash">
            <div class="card-body">
              <h5 class="card-title text-center">Building a Shell, Part 3<br><small class="text-info">Posted: December 04, 2017</small></h5>
              <div class="card-text col-10 mx-auto">
                <p>Next, we’ll add a few built in functions to the shell. Our shell will support
printing the current directory, changing the current directory, and quitting as
built in commands. We’ll also be giving the shell the ability to run some
external commands in the next section of this series. The code for each of these
commands is simple, and the quit command was already included last time. So, the
code for printing the current directory:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">wd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">current_dir</span><span class="p">;</span>
    <span class="n">allocateStr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_dir</span><span class="p">);</span>
    <span class="n">GUARD_PTR</span><span class="p">(</span><span class="n">getcwd</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">MAX_STR</span><span class="p">));</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">current_dir</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the code for changing the directory:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">chwd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">new_path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"The proper usage of %s is %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"chwd"</span><span class="p">,</span> <span class="s">"chwd pathname"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">GUARD</span><span class="p">(</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The functions will then be added to the shell like so:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">_continue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[Command prompt]$ "</span><span class="p">);</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">getLine</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span> <span class="c1">// uses the getLine from yesterdays post.</span>

        <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">" </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">"quit"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_continue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">"wd"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">wd</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">"chwd"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">new_path</span><span class="p">;</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">" </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">chwd</span><span class="p">(</span><span class="n">new_path</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pid_t</span> <span class="n">child</span><span class="p">,</span> <span class="n">wait</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">child_status</span><span class="p">;</span>

            <span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">do</span> <span class="p">{</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child_status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">child_status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">child_status</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">_continue</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>These functions give our shell the beginning of usefullness, and will be
expanded upon tomorrow.</p>

              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-10 col-md-8 col-lg-6 mx-auto text-center">
        <p>© Doug Skinner. All rights reserved</p>
      </div>
    </div>
  </div>
</div>

  </body>
</html>
